Resolving dependencies...
Downloading packages...
  _fe_analyzer_shared 85.0.0 (92.0.0 available)
  analyzer 7.6.0 (9.0.0 available)
  analyzer_buffer 0.1.10 (0.1.11 available)
  analyzer_plugin 0.13.4 (0.13.11 available)
  build 3.1.0 (4.0.2 available)
  build_daemon 4.1.0 (4.1.1 available)
  build_resolvers 3.0.3 (3.0.4 available)
  build_runner 2.7.1 (2.10.1 available)
  build_runner_core 9.3.1 (9.3.2 available)
  characters 1.4.0 (1.4.1 available)
  crypto 3.0.6 (3.0.7 available)
  custom_lint_core 0.8.0 (0.8.1 available)
  custom_lint_visitor 1.0.0+7.7.0 (1.0.0+8.1.1 available)
  dart_style 3.1.1 (3.1.2 available)
  flutter_secure_storage_linux 1.2.3 (2.0.1 available)
  flutter_secure_storage_macos 3.1.3 (4.0.0 available)
  flutter_secure_storage_platform_interface 1.1.2 (2.0.1 available)
  flutter_secure_storage_web 1.2.1 (2.0.0 available)
  flutter_secure_storage_windows 3.1.2 (4.0.0 available)
  http 1.5.0 (1.6.0 available)
  intl 0.19.0 (0.20.2 available)
  js 0.6.7 (0.7.2 available)
  material_color_utilities 0.11.1 (0.13.0 available)
  meta 1.16.0 (1.17.0 available)
  mockito 5.5.0 (5.5.1 available)
  pointycastle 3.9.1 (4.0.0 available)
  source_gen 3.1.0 (4.0.2 available)
  test 1.26.2 (1.26.3 available)
  test_api 0.7.6 (0.7.8 available)
  test_core 0.6.11 (0.6.13 available)
Got dependencies!
30 packages have newer versions incompatible with dependency constraints.
Try `flutter pub outdated` for more information.
00:00 +0: loading /home/abubakar/dev/pak_connect/test/nonce_concurrency_test.dart
00:00 +0: (setUpAll)
00:00 +0: Nonce Concurrency Tests concurrent encryption operations use unique nonces
00:00 +0: (setUpAll)
FINE: Generated 256-bit encryption key
INFO: ğŸ” Generated and stored new database encryption key
INFO: Initializing database at: /home/abubakar/dev/pak_connect/.dart_tool/sqflite_common_ffi/databases/pak_connect_test_1762844272520.db (factory: _SqfliteDatabaseFactoryImpl)
INFO: WAL mode set, journal_mode: wal
INFO: Database configured with foreign keys and optimizations
INFO: Creating database schema v9...
INFO: âœ… Database schema created successfully with 17 core tables + FTS5
INFO: Database closed
FINE: âœ… Using cached encryption key (skipped secure storage read)
INFO: Initializing database at: /home/abubakar/dev/pak_connect/.dart_tool/sqflite_common_ffi/databases/pak_connect_test_1762844272520.db (factory: _SqfliteDatabaseFactoryImpl)
INFO: WAL mode set, journal_mode: wal
INFO: Database configured with foreign keys and optimizations
INFO: Creating database schema v9...
INFO: âœ… Database schema created successfully with 17 core tables + FTS5
00:00 +0: Nonce Concurrency Tests concurrent encryption operations use unique nonces
âœ… Database reset complete. Tables: 21
00:00 +0: (setUpAll)
INFO: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
INFO: STARTING NONCE CONCURRENCY TEST
INFO: Testing 100 concurrent encrypt() calls for nonce uniqueness
INFO: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

INFO: PHASE 1: Establishing Noise session between Alice and Bob
INFO: ğŸ¤ Starting handshake protocol from phase: ConnectionPhase.bleConnected (role: INITIATOR)
INFO: ğŸ“¤ Phase 0: Sending connectionReady
FINE: Alice â†’ Bob: ProtocolMessageType.connectionReady
INFO: ğŸ“¨ Received ProtocolMessageType.connectionReady in phase ConnectionPhase.bleConnected
INFO: ğŸ“¥ Received connectionReady
INFO: ğŸ”„ Peripheral: Received ready, sending our ready (response IS ack)
INFO: âœ… Phase 0 Complete: Both devices ready
INFO: â¸ï¸  Role: RESPONDER - waiting for identity
FINE: Bob â†’ Alice: ProtocolMessageType.connectionReady
INFO: ğŸ“¨ Received ProtocolMessageType.connectionReady in phase ConnectionPhase.readySent
INFO: ğŸ“¥ Received connectionReady
INFO: âœ… Central: Received their ready response - advancing
INFO: âœ… Phase 0 Complete: Both devices ready
INFO: ğŸ“¤ Role: INITIATOR - proceeding to send identity
INFO: ğŸ“¤ Phase 1: Sending identity (ephemeral ID only - privacy-preserving)
FINE: Alice â†’ Bob: ProtocolMessageType.identity
INFO: ğŸ“¨ Received ProtocolMessageType.identity in phase ConnectionPhase.readyComplete
INFO: ğŸ“¥ Received identity (ephemeral ID)
INFO:   Their ephemeral ID: alice_ephemeral
INFO:   Their display name: Alice
INFO: ğŸ”„ Peripheral: Received identity, sending our identity (response IS ack)
INFO: âœ… Phase 1 Complete: Identity exchange done
INFO: â¸ï¸ Role: RESPONDER - waiting for Noise handshake 1
FINE: Bob â†’ Alice: ProtocolMessageType.identity
INFO: ğŸ“¨ Received ProtocolMessageType.identity in phase ConnectionPhase.identitySent
INFO: ğŸ“¥ Received identity (ephemeral ID)
INFO:   Their ephemeral ID: bob_ephemeral
INFO:   Their display name: Bob
INFO: âœ… Central: Received their identity response - advancing
INFO: âœ… Phase 1 Complete: Identity exchange done
INFO: ğŸ“¤ Role: INITIATOR - proceeding to send Noise handshake 1
INFO: ğŸ“¤ Phase 1.5: Initiating Noise handshake
INFO: ğŸ‘¤ No prior Noise key - using XX pattern (first contact)
INFO:   Selected pattern: NoisePattern.xx
INFO: Initiating XX handshake with bob_ephemeral
FINE: Removed session for bob_ephemeral
INFO: [bob_ephemeral] Created XX session as INITIATOR
FINE: Added session for bob_ephemeral
INFO: [bob_ephemeral] Starting XX handshake as INITIATOR
FINE: [bob_ephemeral] Sent XX message 1 (32 bytes)
INFO: Started XX handshake with bob_ephemeral as INITIATOR
INFO:   Generated message 1: 32 bytes (pattern: NoisePattern.xx)
FINE: Alice â†’ Bob: ProtocolMessageType.noiseHandshake1
INFO: ğŸ“¨ Received ProtocolMessageType.noiseHandshake1 in phase ConnectionPhase.identityComplete
INFO: ğŸ“¥ Received Noise handshake 1
INFO:   Received 32 bytes (pattern: XX)
INFO: ğŸ“‰ Peer using XX pattern
FINE: Processing handshake message from alice_ephemeral (32 bytes)
INFO: Creating new RESPONDER session for alice_ephemeral
INFO: [alice_ephemeral] Created XX session as RESPONDER
FINE: Added session for alice_ephemeral
FINE: [alice_ephemeral] Processing handshake message (32 bytes)
INFO: [alice_ephemeral] Starting XX handshake as RESPONDER
FINE: [alice_ephemeral] Responder processing XX message 1
FINE: [alice_ephemeral] Responder sending XX message 2 (80 bytes)
INFO:   Generated message 2: 80 bytes
FINE: Bob â†’ Alice: ProtocolMessageType.noiseHandshake2
INFO: ğŸ“¨ Received ProtocolMessageType.noiseHandshake2 in phase ConnectionPhase.noiseHandshake1Sent
INFO: ğŸ“¥ Received Noise handshake 2 (<- e, ee, s, es)
INFO:   Received 80 bytes
FINE: Processing handshake message from bob_ephemeral (80 bytes)
FINE: [bob_ephemeral] Processing handshake message (80 bytes)
FINE: [bob_ephemeral] Initiator processing XX message 2
FINE: [bob_ephemeral] Initiator sending XX message 3 (48 bytes)
INFO: [bob_ephemeral] XX handshake complete!
INFO: [bob_ephemeral] Session ESTABLISHED - transport ciphers ready
INFO: âœ… Session ESTABLISHED with bob_ephemeral
INFO: Session established with bob_ephemeral (fingerprint: d8d8dd00fc678ecd558e5c9610c7fc72e511b13fa89ed38b8ec0c4e19eb6bbd6)
INFO:   Generated Noise message 3: 48 bytes
FINE: Alice â†’ Bob: ProtocolMessageType.noiseHandshake3
INFO: ğŸ“¨ Received ProtocolMessageType.noiseHandshake3 in phase ConnectionPhase.noiseHandshake2Sent
INFO: ğŸ“¥ Received Noise handshake 3 (-> s, se)
INFO:   Received 48 bytes
FINE: Processing handshake message from alice_ephemeral (48 bytes)
FINE: [alice_ephemeral] Processing handshake message (48 bytes)
FINE: [alice_ephemeral] Responder processing XX message 3
INFO: [alice_ephemeral] XX handshake complete!
INFO: [alice_ephemeral] Session ESTABLISHED - transport ciphers ready
INFO: âœ… Session ESTABLISHED with alice_ephemeral
INFO: Session established with alice_ephemeral (fingerprint: d8d8dd00fc678ecd558e5c9610c7fc72e511b13fa89ed38b8ec0c4e19eb6bbd6)
INFO:   Noise handshake 3 processed successfully
INFO: âœ… Phase 1.5 Complete: Noise session established
INFO:   Peer Noise public key: 22akLdsIA94Zjg1E...
INFO: â¸ï¸ Role: RESPONDER - waiting for contact status
INFO: âœ… Phase 1.5 Complete: Noise session established
INFO:   Peer Noise public key: 22akLdsIA94Zjg1E...
INFO: ğŸ“¤ Role: INITIATOR - proceeding to send contact status
INFO: ğŸ“¤ Phase 2: Sending contact status
FINE: Alice â†’ Bob: ProtocolMessageType.contactStatus
INFO: ğŸ“¨ Received ProtocolMessageType.contactStatus in phase ConnectionPhase.noiseHandshakeComplete
INFO: ğŸ“¥ Received contactStatus
INFO:   They have us as contact: false (may change after pairing)
INFO: ğŸ”„ Peripheral: Received contactStatus, sending our contactStatus (response IS ack)
FINE: Bob â†’ Alice: ProtocolMessageType.contactStatus
INFO: ğŸ“¨ Received ProtocolMessageType.contactStatus in phase ConnectionPhase.contactStatusSent
INFO: ğŸ“¥ Received contactStatus
INFO:   They have us as contact: false (may change after pairing)
INFO: âœ… Central: Received their contactStatus response - completing handshake
INFO: âœ… Phase 2 Complete: Contact status exchange done
INFO: ğŸ‰ HANDSHAKE COMPLETE! Session ready for normal communication
INFO:    Their ephemeral ID: bob_ephemeral
INFO:    (Persistent keys will be exchanged after pairing)
INFO: âœ… Reset KK failure tracking for peer
INFO: âœ… Alice handshake complete with bob_ephemeral
INFO: ğŸ” Updated Noise session for bob_ephe... (state: established)
INFO: Added new node: 22akLdsI (Bob)
INFO: ğŸ“Š Recorded peer in topology: Bob
INFO: âœ… Phase 2 Complete: Contact status exchange done
INFO: ğŸ‰ HANDSHAKE COMPLETE! Session ready for normal communication
INFO:    Their ephemeral ID: alice_ephemeral
INFO:    (Persistent keys will be exchanged after pairing)
INFO: âœ… Reset KK failure tracking for peer
INFO: âœ… Bob handshake complete with alice_ephemeral
INFO: ğŸ“Š Recorded peer in topology: Alice
INFO: âœ… Noise session established

INFO: PHASE 2: Encrypting 100 messages concurrently
INFO: This tests for nonce race condition between:
INFO:   1. getNonce() call
INFO:   2. encryptWithAd() call
INFO: If race exists, same nonce will be used by multiple messages

FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 36)
INFO: âœ… Encrypted 100 messages in 129ms
INFO:    Average: 1.29ms per message

INFO: PHASE 3: Extracting nonces from ciphertext
INFO: Nonce format: First 4 bytes of ciphertext (big-endian)

FINE: Message 0 nonce: 0 (0x00000000)
FINE: Message 1 nonce: 0 (0x00000000)
FINE: Message 2 nonce: 0 (0x00000000)
FINE: Message 3 nonce: 0 (0x00000000)
FINE: Message 4 nonce: 0 (0x00000000)
FINE: Message 5 nonce: 0 (0x00000000)
FINE: Message 6 nonce: 0 (0x00000000)
FINE: Message 7 nonce: 0 (0x00000000)
FINE: Message 8 nonce: 0 (0x00000000)
FINE: Message 9 nonce: 0 (0x00000000)
FINE: ... (80 more) ...
FINE: Message 90 nonce: 0 (0x00000000)
FINE: Message 91 nonce: 0 (0x00000000)
FINE: Message 92 nonce: 0 (0x00000000)
FINE: Message 93 nonce: 0 (0x00000000)
FINE: Message 94 nonce: 0 (0x00000000)
FINE: Message 95 nonce: 0 (0x00000000)
FINE: Message 96 nonce: 0 (0x00000000)
FINE: Message 97 nonce: 0 (0x00000000)
FINE: Message 98 nonce: 0 (0x00000000)
FINE: Message 99 nonce: 0 (0x00000000)
INFO: 
âœ… Extracted 100 nonces

INFO: PHASE 4: Analyzing nonce uniqueness
INFO: Results:
INFO:   Total messages:  100
INFO:   Unique nonces:   1
INFO:   Duplicate nonces: 99
SEVERE: âŒ RACE CONDITION CONFIRMED - Duplicate nonces detected!
SEVERE: Top duplicate nonces:
SEVERE:   Nonce 0 (0x00000000): used 100 times
SEVERE:   Messages sharing nonce 0: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99]
INFO: 
Nonce sequencing:
INFO:   Min nonce: 0 (0x00000000)
INFO:   Max nonce: 0 (0x00000000)
INFO:   Expected range: 99
INFO:   Actual range:   0
WARNING: âš ï¸  Nonce range mismatch (gaps detected)
INFO: 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
INFO: TEST COMPLETE
INFO: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

00:01 +0 -1: Nonce Concurrency Tests concurrent encryption operations use unique nonces [E]
  Expected: <100>
    Actual: <1>
  All 100 messages must use unique nonces. Found 99 duplicates. This indicates a race condition in NoiseSession.encrypt()
  
  package:matcher                                     expect
  package:flutter_test/src/widget_tester.dart 473:18  expect
  test/nonce_concurrency_test.dart 357:7              main.<fn>.<fn>
  
00:01 +0 -1: (setUpAll)
INFO: Database closed
WARNING: Database deleted
00:01 +0 -1: Nonce Concurrency Tests sequential encryption operations produce sequential nonces
00:01 +0 -1: (setUpAll)
FINE: âœ… Using cached encryption key (skipped secure storage read)
INFO: Initializing database at: /home/abubakar/dev/pak_connect/.dart_tool/sqflite_common_ffi/databases/pak_connect_test_1762844272520.db (factory: _SqfliteDatabaseFactoryImpl)
INFO: WAL mode set, journal_mode: wal
INFO: Database configured with foreign keys and optimizations
INFO: Creating database schema v9...
INFO: âœ… Database schema created successfully with 17 core tables + FTS5
INFO: Database closed
FINE: âœ… Using cached encryption key (skipped secure storage read)
INFO: Initializing database at: /home/abubakar/dev/pak_connect/.dart_tool/sqflite_common_ffi/databases/pak_connect_test_1762844272520.db (factory: _SqfliteDatabaseFactoryImpl)
INFO: WAL mode set, journal_mode: wal
INFO: Database configured with foreign keys and optimizations
INFO: Creating database schema v9...
INFO: âœ… Database schema created successfully with 17 core tables + FTS5
00:01 +0 -1: Nonce Concurrency Tests sequential encryption operations produce sequential nonces
âœ… Database reset complete. Tables: 21
00:01 +0 -1: (setUpAll)
INFO: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
INFO: BASELINE TEST: Sequential Encryption
INFO: This test verifies nonces increment correctly WITHOUT concurrency
INFO: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

INFO: ğŸ¤ Starting handshake protocol from phase: ConnectionPhase.bleConnected (role: INITIATOR)
INFO: ğŸ“¤ Phase 0: Sending connectionReady
INFO: ğŸ“¨ Received ProtocolMessageType.connectionReady in phase ConnectionPhase.bleConnected
INFO: ğŸ“¥ Received connectionReady
INFO: ğŸ”„ Peripheral: Received ready, sending our ready (response IS ack)
INFO: âœ… Phase 0 Complete: Both devices ready
INFO: â¸ï¸  Role: RESPONDER - waiting for identity
INFO: ğŸ“¨ Received ProtocolMessageType.connectionReady in phase ConnectionPhase.readySent
INFO: ğŸ“¥ Received connectionReady
INFO: âœ… Central: Received their ready response - advancing
INFO: âœ… Phase 0 Complete: Both devices ready
INFO: ğŸ“¤ Role: INITIATOR - proceeding to send identity
INFO: ğŸ“¤ Phase 1: Sending identity (ephemeral ID only - privacy-preserving)
INFO: ğŸ“¨ Received ProtocolMessageType.identity in phase ConnectionPhase.readyComplete
INFO: ğŸ“¥ Received identity (ephemeral ID)
INFO:   Their ephemeral ID: alice_ephemeral
INFO:   Their display name: Alice
INFO: ğŸ”„ Peripheral: Received identity, sending our identity (response IS ack)
INFO: âœ… Phase 1 Complete: Identity exchange done
INFO: â¸ï¸ Role: RESPONDER - waiting for Noise handshake 1
INFO: ğŸ“¨ Received ProtocolMessageType.identity in phase ConnectionPhase.identitySent
INFO: ğŸ“¥ Received identity (ephemeral ID)
INFO:   Their ephemeral ID: bob_ephemeral
INFO:   Their display name: Bob
INFO: âœ… Central: Received their identity response - advancing
INFO: âœ… Phase 1 Complete: Identity exchange done
INFO: ğŸ“¤ Role: INITIATOR - proceeding to send Noise handshake 1
INFO: ğŸ“¤ Phase 1.5: Initiating Noise handshake
INFO: ğŸ‘¤ No prior Noise key - using XX pattern (first contact)
INFO:   Selected pattern: NoisePattern.xx
INFO: Initiating XX handshake with bob_ephemeral
INFO: [bob_ephemeral] Destroying session
FINE: Removed session for bob_ephemeral
INFO: [bob_ephemeral] Created XX session as INITIATOR
FINE: Added session for bob_ephemeral
INFO: [bob_ephemeral] Starting XX handshake as INITIATOR
FINE: [bob_ephemeral] Sent XX message 1 (32 bytes)
INFO: Started XX handshake with bob_ephemeral as INITIATOR
INFO:   Generated message 1: 32 bytes (pattern: NoisePattern.xx)
INFO: ğŸ“¨ Received ProtocolMessageType.noiseHandshake1 in phase ConnectionPhase.identityComplete
INFO: ğŸ“¥ Received Noise handshake 1
INFO:   Received 32 bytes (pattern: XX)
INFO: ğŸ“‰ Peer using XX pattern
FINE: Processing handshake message from alice_ephemeral (32 bytes)
FINE: [alice_ephemeral] Processing handshake message (32 bytes)
INFO: [alice_ephemeral] Starting XX handshake as RESPONDER
FINE: [alice_ephemeral] Responder processing XX message 1
FINE: [alice_ephemeral] Responder sending XX message 2 (80 bytes)
INFO:   Generated message 2: 80 bytes
INFO: ğŸ“¨ Received ProtocolMessageType.noiseHandshake2 in phase ConnectionPhase.noiseHandshake1Sent
INFO: ğŸ“¥ Received Noise handshake 2 (<- e, ee, s, es)
INFO:   Received 80 bytes
FINE: Processing handshake message from bob_ephemeral (80 bytes)
FINE: [bob_ephemeral] Processing handshake message (80 bytes)
FINE: [bob_ephemeral] Initiator processing XX message 2
FINE: [bob_ephemeral] Initiator sending XX message 3 (48 bytes)
INFO: [bob_ephemeral] XX handshake complete!
INFO: [bob_ephemeral] Session ESTABLISHED - transport ciphers ready
INFO: âœ… Session ESTABLISHED with bob_ephemeral
INFO: Session established with bob_ephemeral (fingerprint: d8d8dd00fc678ecd558e5c9610c7fc72e511b13fa89ed38b8ec0c4e19eb6bbd6)
INFO:   Generated Noise message 3: 48 bytes
INFO: ğŸ“¨ Received ProtocolMessageType.noiseHandshake3 in phase ConnectionPhase.noiseHandshake2Sent
INFO: ğŸ“¥ Received Noise handshake 3 (-> s, se)
INFO:   Received 48 bytes
FINE: Processing handshake message from alice_ephemeral (48 bytes)
FINE: [alice_ephemeral] Processing handshake message (48 bytes)
FINE: [alice_ephemeral] Responder processing XX message 3
INFO: [alice_ephemeral] XX handshake complete!
INFO: [alice_ephemeral] Session ESTABLISHED - transport ciphers ready
INFO: âœ… Session ESTABLISHED with alice_ephemeral
INFO: Session established with alice_ephemeral (fingerprint: d8d8dd00fc678ecd558e5c9610c7fc72e511b13fa89ed38b8ec0c4e19eb6bbd6)
INFO:   Noise handshake 3 processed successfully
INFO: âœ… Phase 1.5 Complete: Noise session established
INFO:   Peer Noise public key: 22akLdsIA94Zjg1E...
INFO: â¸ï¸ Role: RESPONDER - waiting for contact status
INFO: âœ… Phase 1.5 Complete: Noise session established
INFO:   Peer Noise public key: 22akLdsIA94Zjg1E...
INFO: ğŸ“¤ Role: INITIATOR - proceeding to send contact status
INFO: ğŸ“¤ Phase 2: Sending contact status
INFO: ğŸ“¨ Received ProtocolMessageType.contactStatus in phase ConnectionPhase.noiseHandshakeComplete
INFO: ğŸ“¥ Received contactStatus
INFO:   They have us as contact: false (may change after pairing)
INFO: ğŸ”„ Peripheral: Received contactStatus, sending our contactStatus (response IS ack)
INFO: ğŸ“¨ Received ProtocolMessageType.contactStatus in phase ConnectionPhase.contactStatusSent
INFO: ğŸ“¥ Received contactStatus
INFO:   They have us as contact: false (may change after pairing)
INFO: âœ… Central: Received their contactStatus response - completing handshake
INFO: âœ… Phase 2 Complete: Contact status exchange done
INFO: ğŸ‰ HANDSHAKE COMPLETE! Session ready for normal communication
INFO:    Their ephemeral ID: bob_ephemeral
INFO:    (Persistent keys will be exchanged after pairing)
INFO: âœ… Reset KK failure tracking for peer
INFO: ğŸ” Updated Noise session for bob_ephe... (state: established)
INFO: ğŸ“Š Recorded peer in topology: Bob
INFO: âœ… Phase 2 Complete: Contact status exchange done
INFO: ğŸ‰ HANDSHAKE COMPLETE! Session ready for normal communication
INFO:    Their ephemeral ID: alice_ephemeral
INFO:    (Persistent keys will be exchanged after pairing)
INFO: âœ… Reset KK failure tracking for peer
INFO: ğŸ“Š Recorded peer in topology: Alice
INFO: âœ… Noise session established

INFO: Encrypting 100 messages SEQUENTIALLY (await each)
FINE: [bob_ephemeral] Encrypted message (nonce: 0, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 1, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 2, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 3, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 4, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 5, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 6, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 7, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 8, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 9, size: 35)
FINE: [bob_ephemeral] Encrypted message (nonce: 10, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 11, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 12, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 13, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 14, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 15, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 16, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 17, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 18, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 19, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 20, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 21, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 22, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 23, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 24, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 25, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 26, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 27, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 28, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 29, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 30, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 31, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 32, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 33, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 34, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 35, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 36, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 37, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 38, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 39, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 40, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 41, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 42, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 43, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 44, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 45, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 46, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 47, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 48, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 49, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 50, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 51, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 52, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 53, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 54, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 55, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 56, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 57, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 58, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 59, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 60, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 61, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 62, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 63, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 64, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 65, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 66, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 67, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 68, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 69, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 70, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 71, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 72, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 73, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 74, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 75, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 76, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 77, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 78, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 79, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 80, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 81, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 82, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 83, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 84, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 85, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 86, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 87, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 88, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 89, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 90, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 91, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 92, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 93, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 94, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 95, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 96, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 97, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 98, size: 36)
FINE: [bob_ephemeral] Encrypted message (nonce: 99, size: 36)
INFO: âœ… Encrypted 100 messages in 92ms
INFO:    Average: 0.92ms per message

INFO: Results:
INFO:   Total messages:  100
INFO:   Unique nonces:   100
INFO:   Duplicate nonces: 0
INFO: âœ… All nonces are sequential (N, N+1, N+2, ...)
INFO: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

INFO: Database closed
WARNING: Database deleted
00:02 +1 -1: (tearDownAll)
00:02 +1 -1: (setUpAll)
INFO: Shutting down Noise encryption service
INFO: Shutting down Noise session manager
INFO: [alice_ephemeral] Destroying session
INFO: [bob_ephemeral] Destroying session
INFO: All sessions destroyed
INFO: ğŸ”’ SecurityManager shutdown
WARNING: Database deleted
00:02 +1 -1: Some tests failed.
